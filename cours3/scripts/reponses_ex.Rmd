---
title: "Réponses aux exercices du cours 3"
author: Steve Vissault
date: 28 février 2018
output:
  html_document:
    highlight: tango
    toc: true
    toc_float: true
    df_print: paged
---

# Exercice 1


## Consignes

1. Recréer la base de données `bd_films` avec ses deux tables `films` et `acteurs`
2. Insérer les données [bd_acteurs.csv](https://econumuds.github.io/BIO500/cours3/assets/donnees/bd_beacon/bd_acteurs.csv) et [bd_films.csv](https://econumuds.github.io/BIO500/cours3/assets/donnees/bd_beacon/bd_films.csv) dans les deux tables à l'aide de la commande R `dbWriteTable()`


## Solution

NB: Spécifier votre environnement de travail avec `setwd()` ou alors, ouvrez R avec le terminal à l'emplacement que vous désirez (avec cd).

### Étape 1. Creation du fichier qui contiendra la base de données `bd_films`

```{r, echo=FALSE}
system("rm films.db")
```

```{r}
library(RSQLite)
con <- dbConnect(SQLite(), dbname="films.db")
```

Notez ici que si le fichier `films.db` n'existe pas, alors la fonction `dbConnect()` créera le fichier pour vous.
*Je vous ai demandé de créer le fichier pour vous faire pratiquer le terminal.*

### Étape 2. Création de la table `films`

```{r}
films_sql <- "
CREATE TABLE films(
  id_film INTEGER,
  titre VARCHAR,
  annee INTEGER,
  PRIMARY KEY (id_film)
);Injection des données
"
dbSendQuery(con,films_sql)
```

### Étape 3. Création de la table `acteurs`

```{r}
acteurs_sql <- "
CREATE TABLE acteurs(
  id_acteur INTEGER,
  nom VARCHAR,
  prenom VARCHAR,
  id_film INTEGER,
  PRIMARY KEY (id_acteur)
  FOREIGN KEY (id_film) REFERENCES films(id_film) ON DELETE CASCADE
);
"
dbSendQuery(con,acteurs_sql)
```

### Étape 4. Injection des données

```{r}
# Lecture des fichiers
bd_films <- read.csv2("https://econumuds.github.io/BIO500/cours3/assets/donnees/bd_beacon/bd_films.csv", stringsAsFactors = FALSE)
bd_acteurs <- read.csv2("https://econumuds.github.io/BIO500/cours3/assets/donnees/bd_beacon/bd_acteurs.csv", stringsAsFactors = FALSE)

# On vérifie la structure des jeux de données pour s'assurer que l'importation est ok.
str(bd_films)
str(bd_acteurs)

# Injection des données dans les tables SQL
dbWriteTable(con, append=TRUE, name="films", value=bd_films, row.names=FALSE)
dbWriteTable(con, append=TRUE, name="acteurs", value=bd_acteurs, row.names=FALSE)
```

### Étape 5. Dernière vérification

On peut maintenant vérifier que les données sont dans la base de données, en faisant une requête rapide et simple: obtenir le nombre d'entrées par table (nombre de lignes).

```{r}
dbGetQuery(con,"SELECT count(*) AS nb_entrees FROM acteurs;")
dbGetQuery(con,"SELECT count(*) AS nb_entrees FROM films;")
```

# Exercice 2

## Consignes

Dans ta table `acteurs`, essayer de trouver votre acteur préféré avec `LIKE` ou avec `= 'votre_acteur_pref'`

## Solution

```{r}
dbGetQuery(con,"SELECT DISTINCT nom, prenom FROM acteurs WHERE prenom = 'Clint' AND nom = 'Eastwood';")
```

# Exercice 3

## Consignes

À l'aide de la base de données `bd_films`, dénombrer le nombre d'acteurs par films. Quels sont les 10 acteurs les plus prolifiques?

## Solution

```{r}
dbGetQuery(con,"SELECT count(id_film) AS nombre_film, prenom, nom
                FROM acteurs
                GROUP BY nom, prenom
                ORDER BY count(id_film) DESC
                LIMIT 10;")
```

# Exercice 4

## Consignes

Quel film possède le plus d'acteurs?

## Solution

```{r}
dbGetQuery(con,"SELECT max(nombre_acteurs), titre FROM (
                  SELECT count(id_acteur) AS nombre_acteurs, titre
                  FROM acteurs
                  INNER JOIN films USING (id_film)
                  GROUP BY titre
                ) AS nombre_acteurs_par_film;")
```

# Exercice 5

## Consignes

Combien il y a d'acteurs par film en moyenne entre 1940 et 1960?

## Solution

```{r}
dbGetQuery(con,"
            SELECT annee, avg(nombre_acteurs) AS moyenne_nombre_acteurs
            FROM (
              SELECT count(id_acteur) AS nombre_acteurs, titre, annee
                FROM acteurs
                INNER JOIN films USING(id_film)
                WHERE annee >= 1940 AND annee <= 1960
                GROUP BY titre, annee
            ) AS nombre_acteurs_par_film
            GROUP BY annee
            ORDER BY annee;")
```
