---
title       : "Séance 5: La visualisation des données"
subtitle    : "BIO 500 - Méthodes en écologie computationnelle"
author      : "Dominique Gravel & Steve Vissault"
job         : "Laboratoire d'écologie intégrative"
logo        : "logo.png"
framework   : io2012       # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      #
mode        : selfcontained
knit        : slidify::knit2slides
widgets     : [mathjax]
url:
  lib   : ./libraries
license     : by-nc-sa
assets      :
  css: "https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css"

---

# Séance 5

- Ces diapositives sont disponibles en [version web](https://econumuds.github.io/BIO500/cours5/) et en [PDF](./assets/pdf/S5-BIO500.pdf).
- L'ensemble du matériel de cours est disponible sur la page du portail [moodle](https://www.usherbrooke.ca/moodle2-cours/course/view.php?id=12189).
- Vous trouverez du matériel supplémentaire dans le [cours](http://kevincazelles.fr/talks/assets/QCBSGraphsR/Rgraphics.html#4) de [Kevin Cazelles](http://kevincazelles.fr/) et [Nicolas Casajus](http://www.cen.ulaval.ca/membre.aspx?id=3945098&membre=ncasajus) lors d'un atelier de communication visuelle du CSBQ.
- Certaines diapositives sont également extraites de la présentation de [David Taylor](http://dtdata.io/prm/intro_dataviz_csbq.pdf)

---.transition

# Le makefile

---

# Les étapes du travail d'un biologiste

<div style='text-align:center;'>
<img src="assets/img/flow_full_repro.png"  width="90%"></img>
</div>

---

# Qu'est-ce que le makefile ?

**Définition**: le makefile est un fichier qui contient un ensemble de directives qui sont exécutées par l'ordinateur. Les instructions et leurs dépendances sont spécifiées dans le makefile.

---

# À quoi il sert ?

Le makefile est un logiciel permettant d'exécuter une série d'instructions, lorsqu'elles sont nécessaires. Les dépendances sont vérifiées et seulement les instructions qui requièrent une mise à jour sont exécutées.

Nous utiliserons le makefile pour assurer la reproductibilité de la démarche entreprise dans le cours. L'ensemble des instructions nécessaires à la production du rapport, de la création de la base de données à la compilation du document écrit, seront contenues dans le makefile.

---

# Objectifs de la leçon

- Reconnaitre les parties importantes d'un makefile, les règles, les cibles, les dépendances et les actions
- Écrire un makefile simple
- Exécuter un makefile à partir du terminal
- Préparer le makefile pour le projet de session

---

# Anatomie du makefile

```bash
<target>: <dependencies...>
  <commands>
```

---

# `target`

La cible est habituellement le nom d'un fichier généré par la commande.

---

# `dependencies...`

Une dépendance (également appelée _"prerequesite"_) est un fichier qui est utilisé pour créer un autre fichier appelée cible (`"target"`).

La _target_ peut contenir plusieurs dépendances.

Il est néanmoins possible d'avoir un fichier cible qui ne requiert pas de dépendances.

---

# `commands`

La commande est l'action à réaliser. Dans notre cas, nous utiliserons une commande pour exécuter un script R comme :

```bash
Rscript script.R
```

Nous verrons plus tard dans la session le langage de mise en forme LaTeX. Dans ce cas, la commande serait:

```bash
pdflatex manuscrit.tex
```

---

# Un exemple

```bash

# Première étape, on génère des données
data.txt :
  Rscript script1.R

# Seconde étape, on fait un modèle statistique à partir
# de ces données
model.Rdata: data.txt
  Rscript script2.R

# Troisième étape, on produit une figure à partir du modèle
# et des données
figure.pdf: model.Rdata data.txt
  Rscript script3.R

```

Ce fichier s'appelle makefile (sans extension) et il est exécuté en inscrivant simplement la commande `make nomDeLaCible`.

---

# Étape par étape

`Rscript` est un programme permettant d'exécuter du code R sans passer par la console R. On peut utiliser le terminal pour appeler le programme `Rscript` et lui donner comme argument un script R: `Rscript script1.R`

Les commandes sont espacées par une *tabulation* ou 8 espaces. Assurez vous que votre tabulation corresponds bien à 8 espaces.

Ensemble, la cible, les dépendances et les actions constituent une règle. Cet exemple a donc 3 règles.

---

# Comment créer un premier makefile

- Ouvrez un nouveau document au moyen de atom
- Copiez les commandes de l'exemple
- Sauvergardez le fichier, avec pour nom makefile
- Assurez vous de trouver les 3 scripts dans le dépôt git

---

# Script 1

```{r eval=FALSE}
  set.seed(1)
  X <- runif(25, 0, 100)
  Y <- rnorm(25, mean = X*2 + 10, sd = 25)
  write.table(cbind(X,Y), file = "data.txt")
```

---

#  Script 2

```{r eval=FALSE}
data <- read.table("data.txt", header = T)
model <- lm(data$Y ~ data$X)
save(model, file = "model.Rdata")
```

---

#  Script 3

```{r eval=FALSE}
data <- read.table("data.txt", header = T)
load("model.Rdata")

pdf("resultat.pdf", 7 5)
plot(data$X, data$Y, xlab = "X", ylab = "Y")
abline(model)
dev.off()
```

---

#  Exécuter un makefile

Il n'est pas nécessaire de nommer le makefile *makefile*. On peut toujours spécifier un autre nom et l'exécuter ainsi :

```{bash eval = FALSE}
make -f MonMakefile
```

---

# Les dépendances

- Exécutez le makefile une première fois.
- Ensuite, modifiez une valeur dans le fichier data.txt.
- Exécutez le makefile à nouveau pour voir ce qui se produit.

---

# Le makefile comme outil de reproductiblité

La rédaction du makefile nous force à spécifier les différentes étapes de notre démarche, à identifier les entrées et les sorties de différentes instructions à l'ordinateur. De cette façon, le makefile permet de documenter rigoureusement la démarche réalisée.

Il s'agit aussi d'un aide-mémoire qui permet de se rappeler des étapes.

---

# Exercice

Conceptualisez les différentes étapes de la démarche du travail de session jusqu'à présent.

Identifiez les entrées, les sorties et les actions.

---

# Les messages de make

Il est possible de forcer make à réaliser certaines actions. Par exemple, si on exécute à nouveau make

```bash
make
```

On obtient le message :

```bash
make : 'data.txt' is up to date
```

---

# Les messages de make

On peut forcer une étape, par exemple le calcul du modèle, ainsi :

```bash
make model.Rdata
```

Dans ce cas-ci, on obtient le message :

```bash
make: Nothing to be done for 'script2.R'
```

---

# Les messages de make

*up to date* signifie que le makefile a une règle dont la cible est le nom du fichier et qu'il est à jour

*Nothing to be done* indique que le fichier existe, mais que 

- il n'y a pas de règle pour ce fichier
- il y a une règle, mais aucune action à réaliser

---

# Nettoyage du dépôt en fin de script

Il arrive que certains scripts génèrent des fichiers temporaires qui ne doivent pas être conservés inutilement.

Dans l'exemple précédent, on pourrait vouloir éliminer le modèle, qui n'est finalement utilisé que pour réaliser la figure. On peut ainsi inscrire à la fin du makefile :

```bash
clean :
  rm -f model.Rdata
```

`rm -f model.Rdata` va éliminer à la toute fin l'objet R contenant le modèle intitulé `model.Rdata`. Notez ici qu'il n'y a pas de dépendance, ce qui indique que cette opération sera systématiquement exécutée.

---

# Dépendances

L'ordre de présentation des dépendances est arbitraire. Elles ne seront pas nécessairement vérifiées dans l'ordre présenté.

Un truc est de schématiser les dépendances (des noeuds) et les actions (des flèches)

---

# Autres ressources disponibles en ligne :

https://swcarpentry.github.io/make-novice/02-makefiles/

https://gist.github.com/isaacs/62a2d1825d04437c6f08

http://gl.developpez.com/tutoriel/outil/makefile/

http://icps.u-strasbg.fr/people/loechner/public_html/enseignement/GL/make.pdf

--- .transition

# Qu'est-ce qui fait une bonne figure ?

---

# Trop d'information

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Pacala.png" width="70%"></img>
</div>

---

# Non respect des normes graphiques

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Desjardins.png" width="70%"></img>
</div>

---

# Abus de symboles et de couleurs

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Boulangeat.png" width="100%"></img>
</div>


---.transition

# L'art graphique

---

# L'importance des graphiques

<!-- La représentation visuelle de nos données est un **outil de persuasion** permettant d'illustrer nos résultats auprès du public et de nos pairs. Cet outil permet également de mieux comprendre les relations à l'intérieur de nos données par la visualisation. -->

## La représentation visuelle des données permet de:

- Synthétiser l'information.
- Communiquer plus efficacement qu'un tableau.
- Explorer nos données par la visualisation.
- Présenter nos résultats et convaincre.

---

# Explorer nos données par la visualisation

## Voici un exemple illustrant l'importance de visualiser ses données:

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/table_visu.png" width="100%"></img>
</div>

---

# Explorer nos données par la visualisation

## Voici un exemple illustrant l'importance de visualiser ses données:

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/plot_visu.png" height="450px"></img>
</div>

--- &twocol

# Communiquer par les graphiques

*** =left

- Les graphiques sont généralement **plus efficaces à communiquer** un message/un résultat qu'un tableau.

- **Problème:** La représentation graphique peut parfois nous conduire à une **fausse interprétation**. L'idée est de transmettre une idée sans biaiser le lecteur.

*** =right

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/fox.jpg" width="100%"></img>
</div>

<!-- - Problème: ratio 8/3 -->

--- &twocol

# Communiquer par les graphiques

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/deformation.png" width="100%"></img>
</div>


<!-- - Problème: ratio 8/3 -->


---

# Communiquer par les graphiques

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Weisgerber_1.png" width="70%"></img>
</div>

---

# Communiquer par les graphiques

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Weisgerber2.png" width="70%"></img>
</div>


---.transition

# Règles et composantes graphiques

--- &twocol

# Les composantes graphiques

*** =left

- Les axes et échelles.
- Le titre de la figure.
- La légende
- Le [type de représentation des données](http://www.datavizcatalogue.com/).


*** =right

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/viz.png" width="100%"></img>
</div>

--- &twocol

# Les règles graphiques

*** =left

- Une figure doit renvoyer un seul message/résultat.
- Chaque élément d'une figure doit **aider à comprendre** ce message.
- **Choisir le bon type de représentation** permet de mettre en valeur plus facilement ce qui doit être illustré.
- **Attention aux normes graphiques**: Choix des couleurs, taille des caractères, épaisseur de la ligne, disposition des marges, cadrage etc.

*** =right

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/viz.png" width="100%"></img>
</div>

---

# Quelques conseils

- Ne pas **JAMAIS** utiliser de diagramme en pointe de tarte

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/pies_vs_bars.png" width="80%"></img>
</div>

--- &twocol

# Quelques conseils

*** =left

- Éviter les figures 3D.
- Limiter le nombre de dimensions (3 ou 4 dimensions max).
- La multi-dimensionnalité peut être gérée en:
  - Modifiant la forme et la la taille des points
  - Ajoutant des couleurs

*** =right

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/Pacala.png" height="350px"></img>
</div>


--- &twocol

# Quelques conseils

- Limiter le ratio encre/données afin de faciliter la lecture.

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/data2ink.jpg" width="100%"></img>
</div>


--- .transition

# Types de figures

---

# Diagramme de dispersion (Scatter plot)

```{r, echo=FALSE,out.height = '550px', dpi=300, fig.align="center"}
arbres  <- read.csv2("donnees/arbres.csv")
densite <- table(arbres[,c(3,5)])
elevation <- as.numeric(row.names(densite))
plot(elevation, densite[,1], pch = 19, xlab = "Elevation", ylab = "Densité")
points(elevation, densite[,3])
```

---

# Diagrammes à bâtons (Bar plot)

```{r, echo=FALSE,out.height = '550px', dpi=300, fig.align="center"}
arbres  <- read.csv2("donnees/arbres.csv")
n_tot <- table(arbres$esp)
barplot(n_tot)
```

---

# Histogrammes

```{r, echo=FALSE,out.height = '550px', dpi=300, fig.align="center"}
hist(densite[,3])
```

--- &twocol

# Représentation 3-D

```{r, echo=FALSE,out.height = '550px', dpi=300, fig.align="center"}
x <- 10*(1:nrow(volcano))
y <- 10*(1:ncol(volcano))
image(x, y, volcano, col = terrain.colors(100), axes = FALSE)
axis(1, at = seq(100, 800, by = 100))
axis(2, at = seq(100, 600, by = 100))
box()
title(main = "Maunga Whau Volcano", font.main = 4)
```

---

# Lignes de contour

```{r, echo=FALSE,out.height = '550px', dpi=300, fig.align="center"}
x <- 10*(1:nrow(volcano))
y <- 10*(1:ncol(volcano))
image(x, y, volcano, col = terrain.colors(100), axes = FALSE)
axis(1, at = seq(100, 800, by = 100))
axis(2, at = seq(100, 600, by = 100))
box()
title(main = "Maunga Whau Volcano", font.main = 4)
contour(x, y, volcano, levels = seq(90, 200, by = 5),
add = TRUE, col = "black")
```

--- .transition

# Faire une figure étape par étape avec R

---

# Prépares les données adéquatement

- Habituellement un `data.frame` ou `une matrice`
- Une observation par ligne (format long)

--- &twocol

# Ouvrir une fenêtre graphique

*** =left
```{r, eval = FALSE}
dev.new(width = 10, height = 7)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
dev.new(width = 10, height = 7)
```

--- &twocol

# Fixer certains paramètres

```{r, eval = FALSE}
# Fixer la largeur et la hauteur des marges
par(mar = c(5,6,2,1))

# Fixer le nombre de figures en colonnes et rangées
par(mfrow = c(1,1))
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
par(mar = c(5,6,2,1))
```

--- &twocol

# Démarrer une figure avec `plot()`

*** =left
```{r, eval = FALSE}
arbres <- read.csv2("donnees/arbres.csv")
densite <- table(arbres[,c(3,5)])
elevation <- as.numeric(row.names(densite))
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité")
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
arbres <- read.csv2("donnees/arbres.csv")
densite <- table(arbres[,c(3,5)])
elevation <- as.numeric(row.names(densite))
plot(elevation, densite[,1], axes = FALSE, xlab = "Élévation", ylab = "Densité")
```

--- &twocol

# Échelles logarithmiques

*** =left
```{r, eval = FALSE}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      log = "xy")
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center", warning=FALSE, message=FALSE}
plot(elevation, densite[,1], axes = FALSE, xlab = "Élévation", ylab = "Densité", log = "xy")
```

--- &twocol

# Ajuster les tailles de caractères

## Arguments `cex`, `cex.lab` et `cex.axis`

*** =left
```{r, eval = FALSE}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE, xlab = "Élévation", ylab = "Densité", cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
```

--- &twocol

# Modifier les axes

*** =left
```{r, eval = FALSE}
axis(1, seq(0,1000,100))
axis(2)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
```

--- &twocolw w1:55% w2:45%

# Ajouter un titre

*** =left
```{r, eval = FALSE}
title(main = "Densité au long du gradient d'élévation")
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
```

--- &twocol

# Superposer des points d'une autre série de données

*** =left
```{r, eval = FALSE}
points(elevation, densite[,3], pch = 19, cex = 1.5)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
points(elevation, densite[,3], pch = 19, cex = 1.5)
```

--- &twocol

# Superposer des lignes

*** =left
```{r, eval = FALSE}
lines(elevation, densite[,1],lty = 1, lwd = 1.5)
lines(elevation, densite[,3], lty  = 3, lwd = 1.5)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
points(elevation, densite[,3], pch = 19, cex = 1.5)
lines(elevation, densite[,1], lty = 1, lwd = 1.5)
lines(elevation, densite[,3], lty = 3, lwd = 1.5)
```

--- &twocolw w1:40% w2:60%

# Ajouter une ligne de tendance

*** =left
```{r, eval = FALSE}
model = lm(densite[,3]~elevation)
summary(model)
abline(model, col = "darkred")
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
model = lm(densite[,3]~elevation)
summary(model)
```

--- &twocol

# Ajouter une ligne de tendance

*** =left
```{r, eval = FALSE}
model = lm(densite[,3]~elevation)
abline(model, col = "darkred")
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
points(elevation, densite[,3], pch = 19, cex = 1.5)
lines(elevation, densite[,1], lty = 1, lwd = 1.5)
lines(elevation, densite[,3], lty = 3, lwd = 1.5)
model = lm(densite[,3]~elevation)
abline(model, col = "darkred")
```


--- &twocol

# Ajouter une légende

*** =left
```{r, eval = FALSE}
legend("top", bty = "n", pch = c(19,1), lty = 1,
    legend = c("Érable à sucre", "Sapin baumier"),
    cex = 1.5)
```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
points(elevation, densite[,3], pch = 19, cex = 1.5)
lines(elevation, densite[,1], lty = 1, lwd = 1.5)
lines(elevation, densite[,3], lty = 3, lwd = 1.5)
legend("top", bty = "n", pch = c(19,1), lty = 1, legend = c("Érable à sucre", "Sapin baumier"), cex = 1.5)
```

--- &twocol

# Ajouter du texte

*** =left
```{r, eval = FALSE}
r2 <- round(summary(model)$r.squared, 2)
text(x = 850, y = 25, paste("R2=",r2),
    cex = 21.5)

```

*** =right
```{r, echo=FALSE,out.width = '100%', dpi=300, fig.align="center"}
plot(elevation, densite[,1], axes = FALSE,
      xlab = "Élévation", ylab = "Densité",
      cex.lab = 1.5, cex.axis = 1.25, cex = 1.5)
axis(1, seq(0,1000,100))
axis(2)
title(main = "Densité au long du gradient d'élévation")
points(elevation, densite[,3], pch = 19, cex = 1.5)
lines(elevation, densite[,1], lty = 1, lwd = 1.5)
lines(elevation, densite[,3], lty = 3, lwd = 1.5)
legend("top", bty = "n", pch = c(19,1), lty = 1, legend = c("Érable à sucre", "Sapin baumier"), cex = 1.5)
r2 <- round(summary(model)$r.squared, 2)
text(x = 875, y = 25, paste("R2=",r2), cex = 1.5)
```

---

# Pour plus d'information

- `?plot`
- `?par`
- `?axis`
- `?mtext`


--- .transition

# Poursuite du travail de session

---

# Consignes

- Identifiez clairement vos questions de recherche
- Illustrez le réseau de collaborations
- Complétez votre analyse au moyen de 3 figures et 1 tableau

---

# Évaluation

- Clareté des questions et adéquation des figures et du tableau
- Efficacité de la présentation
- Respect de normes graphiques
- Originalité

---

# Lectures

Mills et al. 2015. Archiving Primary Data: Solutions for Long-Term Studies. Trends in Ecology and Evolution.

Poisot et al. 2013. Moving toward a sustainable ecological science : don't let data go to waste ! Ideas in Ecology and Evolution 6: 11-19.
