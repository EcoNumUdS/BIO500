
---

# Les grandes étapes

1. Spécifier la connexion avec le serveur
2. Créer la base de données
3. Créer les tables et spécifier les clés
4. Ajouter de l'information dans les tables
5. Faire des requêtes pour extraire l'information

**Important:**

Pour ceux dont la VM ne fonctionne pas, il possible de faire les exercices de ce cours sur Windows ou MacOSX.


--- .transition

# Retour rapide sur la séance de la semaine dernière

---

# Connexion au serveur


```{r echo=FALSE, include=FALSE}
library(RPostgreSQL)

con <- dbConnect(PostgreSQL(),
        host="localhost",
        port=5432,
        user= "postgres")

# On créé la base de données et on ferme la connexion
dbSendQuery(con,"DROP DATABASE IF EXISTS bd_films;")
dbSendQuery(con,"CREATE DATABASE bd_films;")
dbDisconnect(con)

# On se connecte à la nouvelle base de données
con <- dbConnect(PostgreSQL(),
        host="localhost",
        port=5432,
        user= "postgres",
        dbname="bd_films")
```

```{r eval=FALSE}
library(RPostgreSQL)

con <- dbConnect(PostgreSQL(),
        host="localhost",
        port=5432,
        user= "postgres")

# On créé la base de données et on ferme la connexion
dbSendQuery(con,"DROP DATABASE IF EXISTS bd_films;")
dbSendQuery(con,"CREATE DATABASE bd_films;")
dbDisconnect(con)

# On se connecte à la nouvelle base de données
con <- dbConnect(PostgreSQL(),
        host="localhost",
        port=5432,
        user= "postgres",
        dbname="bd_films")
```

**Question:** Sur ce script, où sont les instructions SQL? Òu sont les commandes R?

---

# Création de la table `films`

```{r}
tbl_films <- "CREATE TABLE films (
    id_film     integer,
    titre       varchar(300),
    annee_prod   integer,
    PRIMARY KEY (id_film)
);"

dbSendQuery(con,tbl_films)
```

---

# Création de la table `acteurs`


```{r}
tbl_acteurs <- "CREATE TABLE acteurs (
    id_acteur   integer,
    nom         varchar(100),
    prenom      varchar(100),
    id_film     integer,
    PRIMARY KEY (id_acteur),
    FOREIGN KEY (id_film) REFERENCES films (id_film) ON DELETE CASCADE
);"

dbSendQuery(con,tbl_acteurs)
```

---

# pgAdmin3

`pgAdmin3` est un client avec une interface graphique permettant de visualiser si les opérations de création de tables ont bien été réalisées.

<div style='text-align:center;margin-top:10px;'>
  <img src="assets/img/pgadmin_table.png" width="70%"></img>
</div>


--- .transition

# Ajouter de l'information dans les tables

---

# SQL - `INSERT`

On veut maintenant insérer des données dans les tables `acteurs` et `films`.

## L'instruction `INSERT` permet d'insérer une ligne à la fois:

```sql
INSERT INTO films(id_film,titre,annee_prod) VALUES (1,'la vie est belle',1997);
INSERT INTO acteurs(id_acteur,prenom,nom,id_film) VALUES(1,'Nicoletta','Braschi',1);
INSERT INTO acteurs(id_acteur,prenom,nom,id_film) VALUES(2,'Roberto','Benigni',1);
```

---

# SQL - `COPY ... FROM`

L'instruction SQL `COPY ... FROM` permet d'insérer plusieurs lignes à la fois:

```sql
COPY films FROM '/Users/SteveVissault/Documents/Git/BIO500/cours4/pres/assets/donnees/bd_beacon/bd_films.csv'
WITH FORMAT CSV HEADER DELIMITER ';';
```

Documentation: [http://docs.postgresql.fr/9.5/sql-copy.html](http://docs.postgresql.fr/9.5/sql-copy.html)

---

# RPostgreSQL - `dbWriteTable`

La librairie RPostgreSQL peut nous aider plus facilement à accomplir cette tâche:

```{r}
# Lecture des fichiers CSV
bd_films <- read.csv2(file='./assets/donnees/bd_beacon/bd_films.csv')
bd_acteurs <- read.csv2(file='./assets/donnees/bd_beacon/bd_acteurs.csv')

# Injection des enregistrements dans la BD
dbWriteTable(con,append=TRUE,name="films",value=bd_films, row.names=FALSE)
dbWriteTable(con,append=TRUE,name="acteurs",value=bd_acteurs, row.names=FALSE)
```

---

# Exercice 1 (10-15 minutes)

Ce premier exercice est important pour la suite de la séance.  

1. Recréer la base de données `bd_films` avec ses deux tables `films` et `acteurs`
2. Insérer les données [bd_acteurs.csv](./assets/donnees/bd_beacon/bd_acteurs.csv) et [bd_films.csv](./assets/donnees/bd_beacon/bd_acteurs.csv) dans les deux tables à l'aide de la commande R `dbWriteTable()`

---

# pgAdmin3

Il est également possible d'insérer des données à partir du logiciel `pgAdmin3`.
