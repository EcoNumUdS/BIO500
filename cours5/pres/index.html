<!DOCTYPE html>
<html>
<head>
  <title>Séance 5: Le makefile</title>
  <meta charset="utf-8">
  <meta name="description" content="Séance 5: Le makefile">
  <meta name="author" content="Dominique Gravel &amp; Steve Vissault">
  <meta name="generator" content="slidify" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link rel="stylesheet" href="./libraries/frameworks/io2012/css/default.css" media="all" >
  <link rel="stylesheet" href="./libraries/frameworks/io2012/css/phone.css" 
    media="only screen and (max-device-width: 480px)" >
  <link rel="stylesheet" href="./libraries/frameworks/io2012/css/slidify.css" >
  <link rel="stylesheet" href="./libraries/highlighters/highlight.js/css/tomorrow.css" />
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->  <link rel=stylesheet href="./assets/css/default.css"></link>
<link rel=stylesheet href="./assets/css/ribbons.css"></link>
<link rel=stylesheet href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css"></link>

  
  <!-- Grab CDN jQuery, fall back to local if offline -->
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
  <script>window.jQuery || document.write('<script src="./libraries/widgets/quiz/js/jquery.js"><\/script>')</script> 
  <script data-main="./libraries/frameworks/io2012/js/slides" 
    src="./libraries/frameworks/io2012/js/require-1.0.8.min.js">
  </script>
  
  

</head>
<body style="opacity: 0">
  <slides class="layout-widescreen">
    
    <!-- LOGO SLIDE -->
        <slide class="title-slide segue nobackground">
  <aside class="gdbar">
    <img src="assets/img/logo.png">
  </aside>
  <hgroup class="auto-fadein">
    <h1>Séance 5: Le makefile</h1>
    <h2>BIO 500 - Méthodes en écologie computationnelle</h2>
    <p>Dominique Gravel &amp; Steve Vissault<br/>Laboratoire d'écologie intégrative</p>
  </hgroup>
  <article></article>
  <footer class = 'license'>
    <a href='http://creativecommons.org/licenses/by-nc-sa/3.0/'>
    <img width = '80px' src = 'http://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-nc-sa.png'>
    </a>
  </footer>
</slide>
    

    <!-- SLIDES -->
    <slide class="" id="slide-1" style="background:;">
  <!--  <a href="#slide-1"></a> -->
  <hgroup>
    <h1>Séance 5</h1>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Ces diapositives sont disponibles en <a href="https://econumuds.github.io/BIO500/cours5/">version web</a> et en <a href="./assets/pdf/S5-BIO500.pdf">PDF</a>.</li>
<li>L&#39;ensemble du matériel de cours est disponible sur la page du portail <a href="https://www.usherbrooke.ca/moodle2-cours/course/view.php?id=12189">moodle</a>.</li>
<li>Vous trouverez du matériel supplémentaire dans le <a href="http://kevincazelles.fr/talks/assets/QCBSGraphsR/Rgraphics.html#4">cours</a> de <a href="http://kevincazelles.fr/">Kevin Cazelles</a> et <a href="http://www.cen.ulaval.ca/membre.aspx?id=3945098&amp;membre=ncasajus">Nicolas Casajus</a> lors d&#39;un atelier de communication visuelle du CSBQ.</li>
<li>Certaines diapositives sont également extraites de la présentation de <a href="http://dtdata.io/prm/intro_dataviz_csbq.pdf">David Taylor</a></li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="transition" id="slide-2" style="background:;">
  <!--  <a href="#slide-2"></a> -->
  <hgroup>
    <h1>Le makefile</h1>
  </hgroup>
  <article data-timings="">
    
  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-3" style="background:;">
  <!--  <a href="#slide-3"></a> -->
  <hgroup>
    <h1>Les étapes du travail d&#39;un biologiste</h1>
  </hgroup>
  <article data-timings="">
    <div style='text-align:center;'>
<img src="assets/img/flow_full_repro.png"  width="90%"></img>
</div>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-4" style="background:;">
  <!--  <a href="#slide-4"></a> -->
  <hgroup>
    <h1>Qu&#39;est-ce que le makefile ?</h1>
  </hgroup>
  <article data-timings="">
    <p><strong>Définition</strong>: le makefile est un fichier qui contient un ensemble de directives qui sont exécutées par l&#39;ordinateur. Les instructions et leurs dépendances sont spécifiées dans le makefile.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-5" style="background:;">
  <!--  <a href="#slide-5"></a> -->
  <hgroup>
    <h1>À quoi il sert ?</h1>
  </hgroup>
  <article data-timings="">
    <p>Le makefile est un logiciel permettant d&#39;exécuter une série d&#39;instructions, lorsqu&#39;elles sont nécessaires. Les dépendances sont vérifiées et seulement les instructions qui requièrent une mise à jour sont exécutées.</p>

<p>Nous utiliserons le makefile pour assurer la reproductibilité de la démarche entreprise dans le cours. L&#39;ensemble des instructions nécessaires à la production du rapport, de la création de la base de données à la compilation du document écrit, seront contenues dans le makefile.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-6" style="background:;">
  <!--  <a href="#slide-6"></a> -->
  <hgroup>
    <h1>Objectifs de la leçon</h1>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Reconnaitre les parties importantes d&#39;un makefile, les règles, les cibles, les dépendances et les actions</li>
<li>Écrire un makefile simple</li>
<li>Exécuter un makefile à partir du terminal</li>
<li>Préparer le makefile pour le projet de session</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-7" style="background:;">
  <!--  <a href="#slide-7"></a> -->
  <hgroup>
    <h1>Anatomie du makefile</h1>
  </hgroup>
  <article data-timings="">
    <pre><code class="bash">&lt;target&gt;: &lt;dependencies...&gt;
  &lt;commands&gt;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-8" style="background:;">
  <!--  <a href="#slide-8"></a> -->
  <hgroup>
    <h1><code>target</code></h1>
  </hgroup>
  <article data-timings="">
    <p>La cible est habituellement le nom d&#39;un fichier généré par la commande.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-9" style="background:;">
  <!--  <a href="#slide-9"></a> -->
  <hgroup>
    <h1><code>dependencies...</code></h1>
  </hgroup>
  <article data-timings="">
    <p>Une dépendance (également appelée <em>&quot;prerequesite&quot;</em>) est un fichier qui est utilisé pour créer un autre fichier appelée cible (<code>&quot;target&quot;</code>).</p>

<p>La <em>target</em> peut contenir plusieurs dépendances.</p>

<p>Il est néanmoins possible d&#39;avoir un fichier cible qui ne requiert pas de dépendances.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-10" style="background:;">
  <!--  <a href="#slide-10"></a> -->
  <hgroup>
    <h1><code>commands</code></h1>
  </hgroup>
  <article data-timings="">
    <p>La commande est l&#39;action à réaliser. Dans notre cas, nous utiliserons une commande pour exécuter un script R comme :</p>

<pre><code class="bash">Rscript script.R
</code></pre>

<p>Nous verrons plus tard dans la session le langage de mise en forme LaTeX. Dans ce cas, la commande serait:</p>

<pre><code class="bash">pdflatex manuscrit.tex
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-11" style="background:;">
  <!--  <a href="#slide-11"></a> -->
  <hgroup>
    <h1>Un exemple</h1>
  </hgroup>
  <article data-timings="">
    <pre><code class="bash">
# Première étape, on génère des données
data.txt :
  Rscript script1.R

# Seconde étape, on fait un modèle statistique à partir
# de ces données
model.Rdata: data.txt
  Rscript script2.R

# Troisième étape, on produit une figure à partir du modèle
# et des données
figure.pdf: model.Rdata data.txt
  Rscript script3.R

</code></pre>

<p>Ce fichier s&#39;appelle makefile (sans extension) et il est exécuté en inscrivant simplement la commande <code>make nomDeLaCible</code>.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-12" style="background:;">
  <!--  <a href="#slide-12"></a> -->
  <hgroup>
    <h1>Étape par étape</h1>
  </hgroup>
  <article data-timings="">
    <p><code>Rscript</code> est un programme permettant d&#39;exécuter du code R sans passer par la console R. On peut utiliser le terminal pour appeler le programme <code>Rscript</code> et lui donner comme argument un script R: <code>Rscript script1.R</code></p>

<p>Les commandes sont espacées par une <em>tabulation</em> ou 8 espaces. Assurez vous que votre tabulation corresponds bien à 8 espaces.</p>

<p>Ensemble, la cible, les dépendances et les actions constituent une règle. Cet exemple a donc 3 règles.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-13" style="background:;">
  <!--  <a href="#slide-13"></a> -->
  <hgroup>
    <h1>Comment créer un premier makefile</h1>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Ouvrez un nouveau document au moyen de atom</li>
<li>Copiez les commandes de l&#39;exemple</li>
<li>Sauvergardez le fichier, avec pour nom makefile</li>
<li>Assurez vous de trouver les 3 scripts dans le dépôt git</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-14" style="background:;">
  <!--  <a href="#slide-14"></a> -->
  <hgroup>
    <h1>Script 1</h1>
  </hgroup>
  <article data-timings="">
    <pre><code class="r">  set.seed(1)
  X &lt;- runif(25, 0, 100)
  Y &lt;- rnorm(25, mean = X*2 + 10, sd = 25)
  write.table(cbind(X,Y), file = &quot;data.txt&quot;)
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-15" style="background:;">
  <!--  <a href="#slide-15"></a> -->
  <hgroup>
    <h1>Script 2</h1>
  </hgroup>
  <article data-timings="">
    <pre><code class="r">data &lt;- read.table(&quot;data.txt&quot;, header = T)
model &lt;- lm(data$Y ~ data$X)
save(model, file = &quot;model.Rdata&quot;)
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-16" style="background:;">
  <!--  <a href="#slide-16"></a> -->
  <hgroup>
    <h1>Script 3</h1>
  </hgroup>
  <article data-timings="">
    <pre><code class="r">data &lt;- read.table(&quot;data.txt&quot;, header = T)
load(&quot;model.Rdata&quot;)

pdf(&quot;resultat.pdf&quot;, 7 5)
plot(data$X, data$Y, xlab = &quot;X&quot;, ylab = &quot;Y&quot;)
abline(model)
dev.off()
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-17" style="background:;">
  <!--  <a href="#slide-17"></a> -->
  <hgroup>
    <h1>Exécuter un makefile</h1>
  </hgroup>
  <article data-timings="">
    <p>Il n&#39;est pas nécessaire de nommer le makefile <em>makefile</em>. On peut toujours spécifier un autre nom et l&#39;exécuter ainsi :</p>

<pre><code class="bash">make -f MonMakefile
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-18" style="background:;">
  <!--  <a href="#slide-18"></a> -->
  <hgroup>
    <h1>Les dépendances</h1>
  </hgroup>
  <article data-timings="">
    <ul>
<li>Exécutez le makefile une première fois.</li>
<li>Ensuite, modifiez une valeur dans le fichier data.txt.</li>
<li>Exécutez le makefile à nouveau pour voir ce qui se produit.</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-19" style="background:;">
  <!--  <a href="#slide-19"></a> -->
  <hgroup>
    <h1>Le makefile comme outil de reproductiblité</h1>
  </hgroup>
  <article data-timings="">
    <p>La rédaction du makefile nous force à spécifier les différentes étapes de notre démarche, à identifier les entrées et les sorties de différentes instructions à l&#39;ordinateur. De cette façon, le makefile permet de documenter rigoureusement la démarche réalisée.</p>

<p>Il s&#39;agit aussi d&#39;un aide-mémoire qui permet de se rappeler des étapes.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-20" style="background:;">
  <!--  <a href="#slide-20"></a> -->
  <hgroup>
    <h1>Exercice</h1>
  </hgroup>
  <article data-timings="">
    <p>Conceptualisez les différentes étapes de la démarche du travail de session jusqu&#39;à présent.</p>

<p>Identifiez les entrées, les sorties et les actions.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-21" style="background:;">
  <!--  <a href="#slide-21"></a> -->
  <hgroup>
    <h1>Les messages de make</h1>
  </hgroup>
  <article data-timings="">
    <p>Il est possible de forcer make à réaliser certaines actions. Par exemple, si on exécute à nouveau make</p>

<pre><code class="bash">make
</code></pre>

<p>On obtient le message :</p>

<pre><code class="bash">make : &#39;data.txt&#39; is up to date
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-22" style="background:;">
  <!--  <a href="#slide-22"></a> -->
  <hgroup>
    <h1>Les messages de make</h1>
  </hgroup>
  <article data-timings="">
    <p>On peut forcer une étape, par exemple le calcul du modèle, ainsi :</p>

<pre><code class="bash">make model.Rdata
</code></pre>

<p>Dans ce cas-ci, on obtient le message :</p>

<pre><code class="bash">make: Nothing to be done for &#39;script2.R&#39;
</code></pre>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-23" style="background:;">
  <!--  <a href="#slide-23"></a> -->
  <hgroup>
    <h1>Les messages de make</h1>
  </hgroup>
  <article data-timings="">
    <p><em>up to date</em> signifie que le makefile a une règle dont la cible est le nom du fichier et qu&#39;il est à jour</p>

<p><em>Nothing to be done</em> indique que le fichier existe, mais que</p>

<ul>
<li>il n&#39;y a pas de règle pour ce fichier</li>
<li>il y a une règle, mais aucune action à réaliser</li>
</ul>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-24" style="background:;">
  <!--  <a href="#slide-24"></a> -->
  <hgroup>
    <h1>Nettoyage du dépôt en fin de script</h1>
  </hgroup>
  <article data-timings="">
    <p>Il arrive que certains scripts génèrent des fichiers temporaires qui ne doivent pas être conservés inutilement.</p>

<p>Dans l&#39;exemple précédent, on pourrait vouloir éliminer le modèle, qui n&#39;est finalement utilisé que pour réaliser la figure. On peut ainsi inscrire à la fin du makefile :</p>

<pre><code class="bash">clean :
  rm -f model.Rdata
</code></pre>

<p><code>rm -f model.Rdata</code> va éliminer à la toute fin l&#39;objet R contenant le modèle intitulé <code>model.Rdata</code>. Notez ici qu&#39;il n&#39;y a pas de dépendance, ce qui indique que cette opération sera systématiquement exécutée.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-25" style="background:;">
  <!--  <a href="#slide-25"></a> -->
  <hgroup>
    <h1>Dépendances</h1>
  </hgroup>
  <article data-timings="">
    <p>L&#39;ordre de présentation des dépendances est arbitraire. Elles ne seront pas nécessairement vérifiées dans l&#39;ordre présenté.</p>

<p>Un truc est de schématiser les dépendances (des noeuds) et les actions (des flèches)</p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-26" style="background:;">
  <!--  <a href="#slide-26"></a> -->
  <hgroup>
    <h1>Autres ressources disponibles en ligne :</h1>
  </hgroup>
  <article data-timings="">
    <p><a href="https://swcarpentry.github.io/make-novice/02-makefiles/">https://swcarpentry.github.io/make-novice/02-makefiles/</a></p>

<p><a href="https://gist.github.com/isaacs/62a2d1825d04437c6f08">https://gist.github.com/isaacs/62a2d1825d04437c6f08</a></p>

<p><a href="http://gl.developpez.com/tutoriel/outil/makefile/">http://gl.developpez.com/tutoriel/outil/makefile/</a></p>

<p><a href="http://icps.u-strasbg.fr/people/loechner/public_html/enseignement/GL/make.pdf">http://icps.u-strasbg.fr/people/loechner/public_html/enseignement/GL/make.pdf</a></p>

  </article>
  <!-- Presenter Notes -->
</slide>
<slide class="" id="slide-27" style="background:;">
  <!--  <a href="#slide-27"></a> -->
  <hgroup>
    <h1>Lectures</h1>
  </hgroup>
  <article data-timings="">
    <p>Milcu, A. et al. 2018. Genotypic variability enhances the reproducibility of an ecological study. Nature Ecology and Evolution 2 : 279-287.</p>

  </article>
  <!-- Presenter Notes -->
</slide>
    <slide class="backdrop"></slide>
  </slides>
  <div class="pagination pagination-small" id='io2012-ptoc' style="display:none;">
    <ul>
      <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=1 title='Séance 5'>
         1
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=2 title='Le makefile'>
         2
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=3 title='Les étapes du travail d&#39;un biologiste'>
         3
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=4 title='Qu&#39;est-ce que le makefile ?'>
         4
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=5 title='À quoi il sert ?'>
         5
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=6 title='Objectifs de la leçon'>
         6
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=7 title='Anatomie du makefile'>
         7
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=8 title='<code>target</code>'>
         8
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=9 title='<code>dependencies...</code>'>
         9
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=10 title='<code>commands</code>'>
         10
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=11 title='Un exemple'>
         11
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=12 title='Étape par étape'>
         12
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=13 title='Comment créer un premier makefile'>
         13
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=14 title='Script 1'>
         14
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=15 title='Script 2'>
         15
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=16 title='Script 3'>
         16
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=17 title='Exécuter un makefile'>
         17
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=18 title='Les dépendances'>
         18
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=19 title='Le makefile comme outil de reproductiblité'>
         19
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=20 title='Exercice'>
         20
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=21 title='Les messages de make'>
         21
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=22 title='Les messages de make'>
         22
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=23 title='Les messages de make'>
         23
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=24 title='Nettoyage du dépôt en fin de script'>
         24
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=25 title='Dépendances'>
         25
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=26 title='Autres ressources disponibles en ligne :'>
         26
      </a>
    </li>
    <li>
      <a href="#" target="_self" rel='tooltip' 
        data-slide=27 title='Lectures'>
         27
      </a>
    </li>
  </ul>
  </div>  <!--[if IE]>
    <script 
      src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js">  
    </script>
    <script>CFInstall.check({mode: 'overlay'});</script>
  <![endif]-->
</body>
  <!-- Load Javascripts for Widgets -->
  
  <!-- MathJax: Fall back to local if CDN offline but local image fonts are not supported (saves >100MB) -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
      }
    });
  </script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!-- <script src="https://c328740.ssl.cf1.rackcdn.com/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script> -->
  <script>window.MathJax || document.write('<script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS":{imageFont:null}});<\/script><script src="./libraries/widgets/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"><\/script>')
</script>
<!-- LOAD HIGHLIGHTER JS FILES -->
  <script src="./libraries/highlighters/highlight.js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <!-- DONE LOADING HIGHLIGHTER JS FILES -->
   
  </html>