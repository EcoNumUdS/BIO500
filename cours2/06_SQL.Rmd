
--- .transition

# Pratique: Du modèle conceptuelle vers le modèle logique

---

# Les grandes étapes avec SQLite3

1. Créer et se connecter au fichier de base de données
2. Créer les tables et spécifier les clés
3. Ajouter de l'information dans les tables
4. Faire des requêtes pour extraire l'information

---&twocolw w1:40% w2:60%

# Se connecter au fichier la BD (SQLite3) via R

*** =right

```{r, warnings=FALSE, message=FALSE, echo=FALSE}
system("rm -f ./assets/data/films.db")
```

```{r, warnings=FALSE, message=FALSE}
library(RSQLite)
con <- dbConnect(SQLite(), dbname="./assets/data/films.db")
## !ATTENTION!: Ceci est mon chemin d'accès vers le fichier!
## Astuces: getwd() et setwd()
```

```{r, eval=FALSE}
dbSendQuery(con,"Instructions SQL à envoyer;")
```

*** =left

- `con` est un objet contenant la connexion avec le serveur/fichier de base de données.
- On utilisera la fonction `dbSendQuery()` pour envoyer les instructions SQL.
- Le deuxième argument de la fonction `dbSendQuery()` est une chaine de caractères contenant les instructions SQL.


---&twocol

# Création d'une première table avec clé primaire

*** =left

Voici un exemple d'instruction SQL pour créer la table `films`.

```sql
CREATE TABLE films (
    code        VARCHAR(5),
    titre       VARCHAR(40),
    did         INTEGER,
    date_prod   DATE,
    genre       VARCHAR(10),
    duree       INTEGER,
    PRIMARY KEY(code,titre)
);
```

*** =right

- `films` est le nom de la table
- Chaque attribut de la table (`code`,`titre` etc) dispose d'un type de données (`char(5)`, `varchar(40)` etc) [Type de données SQLite](https://www.sqlite.org/datatype3.html)
- La dernière ligne correspond aux contraintes de la table telle que la clé primaire.
- **Question:** Cette clé primaire est composite ou simple?

---&twocol

# Création d'une table avec clé étrangère

*** =left

Si l'on veut créer une table `acteurs` et référencer cette table à la table `films`.

```sql
CREATE TABLE acteurs (
    nom         VARCHAR(40),
    prenom      VARCHAR(40),
    naissance   DATE,
    code        CHAR(5),
    titre       VARCHAR(40),
    PRIMARY KEY (nom,prenom),
    FOREIGN KEY (code, titre) REFERENCES
        films (code, titre) ON DELETE CASCADE
);
```

*** =right

- On déclare `prenom` et `nom` comme étant la clé primaire de la table `acteurs`.
- On référence les attributs `code` et `titre` comme étant la clé étrangère.

---&twocol

# Création d'une table avec clé étrangère

*** =left

Si l'on veut créer une table `acteurs` et référencer cette table à la table `films`.

```sql
CREATE TABLE acteurs (
    nom         VARCHAR(40),
    prenom      VARCHAR(40),
    naissance   DATE,
    code        CHAR(5),
    titre       VARCHAR(40),
    PRIMARY KEY (nom,prenom),
    FOREIGN KEY (code, titre) REFERENCES
        films (code, titre) ON DELETE CASCADE
);
```

*** =right

## Important:

- On ne peut plus insérer d'acteurs jouant dans un film qui n'est pas référencé dans la table `films`. C'est ce que l'on appelle l'intégrité référentielle.
- Lorsque l'on supprime un enregistrement dans `films`, les acteurs référencés à ce film vont être automatiquement supprimés grâce à l'instruction `CASCADE`.


---

# Ajout de contraintes à une table

SQL présente également l'avantage de pouvoir mettre des contraintes sur les champs:

```sql
CREATE TABLE films (
    code        VARCHAR(5) NOT NULL,
    titre       VARCHAR(40) NOT NULL,
    did         INTEGER,
    date_prod   DATE,
    genre       VARCHAR(10) DEFAULT "COMEDIE",
    duree       INTEGER CHECK( duree > 0 ),
    PRIMARY KEY(code,titre)
);
```

- Les contraintes `NOT NULL` sur la clé primaire ne sont pas obligées d'être définis. 

---

# Création d'une table avec R

## On se sert de R pour envoyer l'instruction SQL de création de la table:

```{r, eval=FALSE}

films_sql <- "
CREATE TABLE films (
    code        VARCHAR(5),
    titre       VARCHAR(40),
    did         INTEGER,
    date_prod   DATE,
    genre       VARCHAR(10),
    duree       INTEGER,
    PRIMARY KEY(code,titre)
);"

dbSendQuery(con,films_sql)
dbListTables(con)
```

---

# Création d'une table

## Exercice pour le travail de session (20 minutes):

En vous inspirant des [exemples](http://www.sqlitetutorial.net/sqlite-create-table/) et de la syntaxe SQL expliquée précédemment, écrivez le script contenant les instructions SQL permettant la création de table `personnes`.

- [Documentation SQL pour SQLite3](https://www.sqlite.org/lang.html)
- [Type de données SQLite](https://www.sqlite.org/datatype3.html)


---

# Modifier la table existante

```sql
ALTER TABLE database_name.table_name RENAME TO new_table_name;
ALTER TABLE database_name.table_name ADD COLUMN column_def...;
```

Il peut être parfois préférable supprimer la table et de la reconstruire plutôt que de la modifier à la volée.

---

# Supprimer la table de données

```{r, eval=FALSE}
dbSendQuery(con,"DROP TABLE films;")
```

- `DROP TABLE` supprime l'ensemble de la table et ses données.

---

# Supprimer la base de données

```{r, eval=FALSE}
dbSendQuery(con,"DROP DATABASE films;")
dbDisconnect(con)
```

- `DROP DATABASE` fonctionne seulement avec d'autres SGBDs (approche serveur).
- Dans le cas de SQLite3, on supprime simplement le fichier `*.db`.
- `dbDisconnect(con)` permet de fermer la connection avec le fichier de base de données (permet à un autre utilisateur de se connecter).


---

# Lectures et travail pour la semaine prochaine

## Travail

Maintenant que vous en savez plus sur le format des données, vous devez écrire le script R pour créer votre base de données en spécifiant les tables, les champs et les clés liant les tables entre elles.


---

# Lectures et travail pour la semaine prochaine

## Travail

- Poisot et al. 2014. Moving toward a sustainable ecological science: don't let data go to waste ! Ideas in Ecology and Evolution 6: 11-19
- Mills et al. 2015. Archivin Primary Data: Solutions for Long-term Studies. Trends in Ecology and Evolution.
